import { PoolClient } from 'pg';
import { DATASET_UPTREND, DATASET_DOWNTREND, DATASET_PIN_BAR } from './ohlc_generator';

interface Question {
  type: 'multiple_choice' | 'true_false' | 'visual';
  question_text: string;
  options: string[] | null;
  correct_answer: string;
  explanation: string;
  visual_config: object | null;
  order_num: number;
}

interface LessonData {
  order_num: number;
  title: string;
  content: string;
  visual_type: string | null;
  visual_config: object | null;
  common_mistakes: string[];
  key_takeaways: string[];
  estimated_minutes: number;
  questions: Question[];
}

export async function seedLevel1(client: PoolClient, levelId: number): Promise<void> {
  const lessons: LessonData[] = [
    {
      order_num: 1,
      title: 'What is Price Action Trading?',
      content: `Price action trading means making decisions based solely on reading raw price movement on a chart, without relying on lagging indicators like RSI or MACD. The premise: price encodes all available information — news, sentiment, institutional activity — through the collective actions of all participants. By reading how price behaves at key levels, what candle patterns form, and whether momentum is accelerating or fading, you extract high-probability signals. Price action is a discretionary skill developed through screen time and deliberate study. Beginners should master three fundamentals first: trend identification, key level recognition, and candle behavior. Everything else — patterns, setups, strategies — builds on these three pillars.`,
      visual_type: null,
      visual_config: null,
      common_mistakes: [
        'Applying price action without first mastering trend identification',
        'Seeing setups where none genuinely exist',
        'Mixing clean price action with conflicting indicator signals',
        'Treating every candle pattern as equally reliable in all contexts',
        'Skipping broader structure and context analysis',
      ],
      key_takeaways: [
        'Price action uses raw price — no lagging indicators required',
        'Price encodes the collective sentiment of all market participants',
        'Master trend identification, key levels, and candle behavior first',
        'Probability, not certainty, is the goal of any setup',
        'Screen time and journaling develop the skill faster than theory alone',
      ],
      estimated_minutes: 4,
      questions: [
        {
          type: 'multiple_choice',
          question_text: 'Price action trading is primarily based on:',
          options: ['Lagging indicators like RSI and MACD', 'Raw price movement and market structure', 'Fundamental news and earnings reports', 'Automated signals from trading bots'],
          correct_answer: 'Raw price movement and market structure',
          explanation: 'Price action traders read the raw movement of price on the chart, believing price encodes all available information.',
          visual_config: null,
          order_num: 1,
        },
        {
          type: 'true_false',
          question_text: 'Price action traders must use indicators like MACD to confirm every entry signal.',
          options: null,
          correct_answer: 'false',
          explanation: 'Pure price action relies on price structure, candle behavior, and key levels — no lagging indicators required.',
          visual_config: null,
          order_num: 2,
        },
        {
          type: 'multiple_choice',
          question_text: 'The three core fundamentals for a price action beginner are:',
          options: [
            'Volume, spread, and news analysis',
            'Trend identification, key levels, and candle behavior',
            'Fibonacci, MACD, and RSI divergence',
            'Copy trading, signals, and pattern bots',
          ],
          correct_answer: 'Trend identification, key levels, and candle behavior',
          explanation: 'All price action setups build on these three: know the trend, find the levels, read the candles at those levels.',
          visual_config: null,
          order_num: 3,
        },
        {
          type: 'true_false',
          question_text: 'A valid price action setup guarantees the trade will be profitable.',
          options: null,
          correct_answer: 'false',
          explanation: 'Price action gives probabilities, not certainties. Even high-quality setups fail — risk management protects you when they do.',
          visual_config: null,
          order_num: 4,
        },
        {
          type: 'multiple_choice',
          question_text: 'What primarily develops the discretionary skill required for price action trading?',
          options: [
            'Faster internet and multiple monitors',
            'Screen time, deliberate study, and journaling',
            'More indicators on the chart',
            'Subscribing to more trading signals',
          ],
          correct_answer: 'Screen time, deliberate study, and journaling',
          explanation: 'Reading charts consistently and reviewing your decisions through journaling builds the pattern-recognition skill that drives price action trading.',
          visual_config: null,
          order_num: 5,
        },
      ],
    },
    {
      order_num: 2,
      title: 'Swing Highs and Swing Lows',
      content: `A swing high is a candle (or group of candles) whose high exceeds the highs of the candles immediately before and after it — a local peak. A swing low is the mirror: a trough where the low is lower than surrounding candles. Swing highs and lows are the building blocks of all price structure. They define trends: a series of higher swing highs and higher swing lows = uptrend; lower swing lows and lower swing highs = downtrend. Old swing highs become resistance; old swing lows become support. Focus on structurally significant pivots — major turning points on your timeframe — and ignore minor noise.`,
      visual_type: 'candlestick',
      visual_config: {
        type: 'candlestick',
        data: DATASET_UPTREND,
        caption: 'Uptrend with visible swing highs (peaks) and swing lows (troughs), each higher than the last.',
      },
      common_mistakes: [
        'Labeling every minor price dip or peak as a swing',
        'Using only one timeframe for swing analysis',
        'Ignoring the momentum context around a swing point',
        'Forgetting that old swing highs become resistance and vice versa',
        'Over-labeling charts with too many minor swings',
      ],
      key_takeaways: [
        'Swing high = local peak; swing low = local trough',
        'They are the building blocks of all price structure analysis',
        'HH + HL = uptrend; LL + LH = downtrend',
        'Old swing highs → potential resistance; old swing lows → potential support',
        'Focus on significant swings; ignore minor noise',
      ],
      estimated_minutes: 4,
      questions: [
        {
          type: 'multiple_choice',
          question_text: 'A swing high is defined as:',
          options: [
            'The all-time highest price on the chart',
            'A local peak where the high exceeds the highs of surrounding candles',
            'Any green candle that closes near its high',
            'A high formed specifically after a news event',
          ],
          correct_answer: 'A local peak where the high exceeds the highs of surrounding candles',
          explanation: 'A swing high is a relative peak — its high must be higher than the candles immediately before and after it.',
          visual_config: null,
          order_num: 1,
        },
        {
          type: 'true_false',
          question_text: 'A series of higher swing highs and higher swing lows defines a downtrend.',
          options: null,
          correct_answer: 'false',
          explanation: 'HH + HL defines an uptrend. A downtrend requires lower lows (LL) and lower highs (LH).',
          visual_config: null,
          order_num: 2,
        },
        {
          type: 'multiple_choice',
          question_text: 'Old swing highs in price action typically act as:',
          options: ['Irrelevant historical data', 'Future support', 'Future resistance', 'Breakout targets only'],
          correct_answer: 'Future resistance',
          explanation: 'Sellers appeared at a previous swing high; they are likely to reappear at that same level on a subsequent visit, making it resistance.',
          visual_config: null,
          order_num: 3,
        },
        {
          type: 'true_false',
          question_text: 'Every minor dip in price should be labeled and analyzed as a significant swing low.',
          options: null,
          correct_answer: 'false',
          explanation: 'Only structurally significant swings — major turning points formed with momentum — are worth labeling. Minor noise creates chart clutter.',
          visual_config: null,
          order_num: 4,
        },
        {
          type: 'multiple_choice',
          question_text: 'Swing highs and swing lows together form the basis of:',
          options: ['Indicator analysis', 'Price structure analysis', 'Volume profile', 'Fibonacci retracement levels'],
          correct_answer: 'Price structure analysis',
          explanation: 'All price structure — trends, ranges, S/R levels, BOS, and CHOCH — is built from identifying and reading the sequence of swing highs and lows.',
          visual_config: null,
          order_num: 5,
        },
      ],
    },
    {
      order_num: 3,
      title: 'Identifying Trends with Price Structure',
      content: `The most reliable way to define a trend is through price structure. An uptrend requires price to consistently produce higher swing highs (HH) and higher swing lows (HL) — each pullback must find support above the previous pullback low. A downtrend requires consistently lower swing lows (LL) and lower swing highs (LH). The trend remains valid until structure breaks. A break occurs when price fails to make a new HH in an uptrend and then drops below the prior HL — a potential reversal signal. Trend strength also matters: shallow pullbacks indicate a strong trend; deeper retracements suggest weakening momentum. Always start with higher-timeframe structure before drilling into lower timeframes.`,
      visual_type: null,
      visual_config: null,
      common_mistakes: [
        'Calling a trend reversal after just one failed swing high',
        'Ignoring higher-timeframe structure while analyzing lower TF',
        'Confusing deep consolidation with a trend reversal',
        'Not adjusting structural labels as price extends far',
        'Treating all trends as equal in strength regardless of pullback depth',
      ],
      key_takeaways: [
        'Uptrend: HH + HL; downtrend: LL + LH',
        'Trend stays valid until structure is broken',
        'One failed swing is a warning; structure break confirms reversal',
        'Shallow pullbacks = strong trend; deep retracements = weakening',
        'Always start analysis on the higher timeframe first',
      ],
      estimated_minutes: 5,
      questions: [
        {
          type: 'multiple_choice',
          question_text: 'In an uptrend, each pullback must do what to keep the trend intact?',
          options: [
            'Break below the previous swing low',
            'Stay above the previous swing low (higher low)',
            'Reach exactly the 50% retracement level',
            'Form a doji candle at the pullback bottom',
          ],
          correct_answer: 'Stay above the previous swing low (higher low)',
          explanation: 'A higher low is what maintains the HH + HL structure. If the pullback breaks the prior HL, the uptrend is under threat.',
          visual_config: null,
          order_num: 1,
        },
        {
          type: 'true_false',
          question_text: 'A single failed higher high immediately and definitively confirms a trend reversal.',
          options: null,
          correct_answer: 'false',
          explanation: 'One failed HH is a warning sign. A confirmed reversal requires the prior higher low to also break, creating a new lower low.',
          visual_config: null,
          order_num: 2,
        },
        {
          type: 'multiple_choice',
          question_text: 'A downtrend is confirmed by which sequence?',
          options: [
            'Higher highs and higher lows',
            'Lower lows and lower highs',
            'Consolidation at a resistance level',
            'Volume divergence on an indicator',
          ],
          correct_answer: 'Lower lows and lower highs',
          explanation: 'LL + LH is the structural definition of a downtrend — each rally fails lower and each decline reaches lower than the last.',
          visual_config: null,
          order_num: 3,
        },
        {
          type: 'true_false',
          question_text: 'Shallow pullbacks within an uptrend suggest the trend is losing momentum.',
          options: null,
          correct_answer: 'false',
          explanation: 'Shallow pullbacks indicate strong buying pressure — buyers are unwilling to let price pull back far before pushing higher again.',
          visual_config: null,
          order_num: 4,
        },
        {
          type: 'multiple_choice',
          question_text: 'When does a potential uptrend break begin?',
          options: [
            'When RSI hits oversold territory',
            'When price fails to make a new HH and then breaks below the prior HL',
            'After three consecutive red candles',
            'When the spread widens on the broker platform',
          ],
          correct_answer: 'When price fails to make a new HH and then breaks below the prior HL',
          explanation: 'This two-step failure — no new HH followed by a break of the prior HL — is the structural signal of a potential trend change.',
          visual_config: null,
          order_num: 5,
        },
      ],
    },
    {
      order_num: 4,
      title: 'Support and Resistance Zones',
      content: `Support is a price area where buying interest has historically halted or reversed a decline. Resistance is where selling interest has halted or reversed a rally. These are zones, not exact lines — treat them as bands of 5–20 pips (or points) wide. Zones are validated by the number and quality of prior reactions. When price breaks through resistance convincingly, that zone often flips to support (role reversal / polarity). Draw zones from body to body — the bodies show where meaningful decisions occurred; wicks show extremes. Higher-timeframe S/R zones carry more weight. Combine a higher-TF zone with a lower-TF candle signal for precise, lower-risk entries.`,
      visual_type: null,
      visual_config: null,
      common_mistakes: [
        'Drawing support/resistance as single exact price lines',
        'Treating every minor bounce as significant S/R',
        'Ignoring zone polarity (resistance becoming support after a break)',
        'Relying only on lower-timeframe S/R without higher-TF context',
        'Not considering how many times a zone has been tested',
      ],
      key_takeaways: [
        'S/R are zones (price bands), not exact single lines',
        'Validated by number and quality of prior reactions',
        'Role reversal: broken resistance becomes future support',
        'Higher-timeframe S/R carries more weight',
        'Combine HTF zone with LTF candle signal for best entries',
      ],
      estimated_minutes: 5,
      questions: [
        {
          type: 'multiple_choice',
          question_text: 'A support zone that price breaks through convincingly typically becomes:',
          options: ['Irrelevant — it no longer matters', 'Resistance on future retests (role reversal)', 'A stronger support level going forward', 'A breakout target only'],
          correct_answer: 'Resistance on future retests (role reversal)',
          explanation: 'Once buyers fail to defend a support and it breaks, sellers take over that level — it flips to resistance. This is called polarity or role reversal.',
          visual_config: null,
          order_num: 1,
        },
        {
          type: 'true_false',
          question_text: 'Support and resistance levels should always be drawn as single precise price lines.',
          options: null,
          correct_answer: 'false',
          explanation: 'Markets react to areas, not exact pip levels. Drawing S/R as zones (bands) is more realistic and practical.',
          visual_config: null,
          order_num: 2,
        },
        {
          type: 'multiple_choice',
          question_text: 'What strengthens the significance of a support/resistance zone?',
          options: [
            'A single test with no reaction',
            'Multiple tests resulting in strong reversals',
            'Being located on a 1-minute chart',
            'Appearing immediately after a news event',
          ],
          correct_answer: 'Multiple tests resulting in strong reversals',
          explanation: 'Each time price reacts strongly at a zone, it confirms that participants are actively trading there — making future reactions more likely.',
          visual_config: null,
          order_num: 3,
        },
        {
          type: 'true_false',
          question_text: 'A resistance zone that price breaks through can act as support on a subsequent retest.',
          options: null,
          correct_answer: 'true',
          explanation: 'This is the role reversal principle: resistance breaks and becomes the new support, as buyers now defend that previously resistant level.',
          visual_config: null,
          order_num: 4,
        },
        {
          type: 'multiple_choice',
          question_text: 'Higher-timeframe support/resistance zones compared to lower-timeframe zones are generally:',
          options: [
            'Less reliable and more likely to break',
            'More significant and harder to overcome',
            'Identical in reliability',
            'Only relevant for long-term investors',
          ],
          correct_answer: 'More significant and harder to overcome',
          explanation: 'HTF zones are built from more transactions and respected by larger participants. They require more force to break.',
          visual_config: null,
          order_num: 5,
        },
      ],
    },
    {
      order_num: 5,
      title: 'Breakouts and Fakeouts',
      content: `A breakout occurs when price moves decisively beyond a key level — a strong candle body closing convincingly beyond the boundary with momentum. Breakouts signal potential new directional moves. However, a fakeout (false break) occurs when price briefly pierces the level, traps breakout traders, then reverses sharply back inside. Fakeouts are common near significant highs/lows and round numbers. Identifying genuine vs. false breaks: genuine breakouts show a full-bodied candle closing well beyond the level; suspicious are wicks that barely poke through. Waiting for a retest of the broken level — now acting as S/R — offers a higher-probability entry with clearly defined risk versus chasing the initial break.`,
      visual_type: null,
      visual_config: null,
      common_mistakes: [
        'Chasing breakouts immediately on the candle that breaks the level',
        'Not waiting for retest confirmation before entering',
        'Ignoring broader context (breakout against major HTF trend)',
        'Treating a wick poke through a level as a confirmed breakout',
        'Using full position size on first breakout attempts',
      ],
      key_takeaways: [
        'Genuine breakout: strong full-body candle closing beyond the level',
        'Fakeout: brief breach then reversal, trapping breakout traders',
        'Retest of broken level offers better R:R than chasing the initial break',
        'Fakeouts are most common at obvious highs, lows, and round numbers',
        'Breakouts against the HTF trend are higher-risk',
      ],
      estimated_minutes: 5,
      questions: [
        {
          type: 'multiple_choice',
          question_text: 'A "fakeout" (false breakout) is when:',
          options: [
            'Price breaks a level with strong momentum and trends far away',
            'Price briefly moves beyond a level then reverses back inside it',
            'Price consolidates tightly at a level before breaking',
            'Volume spikes on the breakout candle',
          ],
          correct_answer: 'Price briefly moves beyond a level then reverses back inside it',
          explanation: 'Fakeouts trap traders who entered the breakout. Price hunts stops above/below the level then returns, leaving breakout traders underwater.',
          visual_config: null,
          order_num: 1,
        },
        {
          type: 'true_false',
          question_text: 'Waiting for a retest of a broken level typically provides better risk/reward than immediately chasing the initial breakout.',
          options: null,
          correct_answer: 'true',
          explanation: 'On the retest, you enter with the broken level as nearby support/resistance, allowing a tight stop and clear R:R calculation.',
          visual_config: null,
          order_num: 2,
        },
        {
          type: 'multiple_choice',
          question_text: 'A genuine breakout is best characterized by:',
          options: [
            'A wick that barely pokes through the level',
            'Three candles slowly drifting across the level',
            'A strong full-body candle closing convincingly beyond the level with momentum',
            'High spread during the move',
          ],
          correct_answer: 'A strong full-body candle closing convincingly beyond the level with momentum',
          explanation: 'A decisive close — with body, not just a wick — beyond the level with clear momentum is the signature of a genuine breakout.',
          visual_config: null,
          order_num: 3,
        },
        {
          type: 'true_false',
          question_text: 'Fakeouts are rare events that seldom occur at key price levels.',
          options: null,
          correct_answer: 'false',
          explanation: 'Fakeouts are very common, especially at obvious swing highs/lows and round numbers where retail stop-loss orders cluster.',
          visual_config: null,
          order_num: 4,
        },
        {
          type: 'multiple_choice',
          question_text: 'Breakouts that go against the dominant higher-timeframe trend are considered:',
          options: ['Lower risk due to the surprise factor', 'Higher risk and statistically less reliable', 'Always valid if the breakout level is clear', 'The most consistently profitable trade type'],
          correct_answer: 'Higher risk and statistically less reliable',
          explanation: 'Fighting the dominant HTF trend means going against the force that is most likely to continue. Counter-trend breakouts fail more often.',
          visual_config: null,
          order_num: 5,
        },
      ],
    },
    {
      order_num: 6,
      title: 'Rejection Candles and Pin Bars',
      content: `A rejection candle has a wick significantly longer than its body in one direction, indicating price was aggressively pushed back from that area. The pin bar is the purest rejection: small body near one end, long wick on the other side. A bullish pin bar has a long lower wick — price dipped but buyers rejected it and closed near the open, signaling potential buying opportunity. A bearish pin bar has a long upper wick — sellers rejected higher prices. Quality criteria: wick should be at least twice the body length; the pin bar must form at a significant level (support/resistance, key swing); and the signal is most powerful when aligned with the higher-timeframe trend.`,
      visual_type: 'candlestick',
      visual_config: {
        type: 'candlestick',
        data: DATASET_PIN_BAR,
        caption: 'A bullish pin bar at the end of this sequence: long lower wick shows buyers rejected lower prices strongly.',
      },
      common_mistakes: [
        'Taking pin bars that form in random price space with no key level',
        'Ignoring the higher-timeframe directional bias',
        'Accepting pin bars with short wicks relative to the body',
        'Over-trading pin bars on noisy low timeframes',
        'Not checking that the signal aligns with the overall trend',
      ],
      key_takeaways: [
        'Pin bar = small body + long wick on one side',
        'Bullish pin bar: long lower wick at support',
        'Bearish pin bar: long upper wick at resistance',
        'Best signals form at significant S/R levels aligned with trend',
        'Wick should be at least 2× the body length for quality',
      ],
      estimated_minutes: 5,
      questions: [
        {
          type: 'multiple_choice',
          question_text: 'A bullish pin bar is best characterized by:',
          options: [
            'Long upper wick and small body near the bottom',
            'Small body near the top and a long lower wick',
            'Two candles where the second engulfs the first',
            'A doji with perfectly equal upper and lower wicks',
          ],
          correct_answer: 'Small body near the top and a long lower wick',
          explanation: 'The long lower wick shows price was pushed far down but buyers rejected those prices and closed near the high — a bullish signal.',
          visual_config: null,
          order_num: 1,
        },
        {
          type: 'true_false',
          question_text: 'Pin bars that form in random price space (not at key S/R levels) are highly reliable trading signals.',
          options: null,
          correct_answer: 'false',
          explanation: 'A pin bar in empty space lacks confluence. It needs to form at a significant level — support, resistance, or swing point — to be meaningful.',
          visual_config: null,
          order_num: 2,
        },
        {
          type: 'multiple_choice',
          question_text: 'For a quality pin bar signal, the wick should be at minimum:',
          options: ['Shorter than the body', 'Exactly equal to the body length', 'At least twice the length of the body', 'Any length is acceptable if the level is strong'],
          correct_answer: 'At least twice the length of the body',
          explanation: 'The wick must demonstrate decisive rejection. A wick shorter than the body does not show sufficient rejection pressure.',
          visual_config: null,
          order_num: 3,
        },
        {
          type: 'true_false',
          question_text: 'A bearish pin bar forming at a strong resistance level in a downtrend is a high-quality signal.',
          options: null,
          correct_answer: 'true',
          explanation: 'Confluence: bearish pin bar (rejection) + resistance (key level) + downtrend (HTF alignment) = three factors supporting a short setup.',
          visual_config: null,
          order_num: 4,
        },
        {
          type: 'visual',
          question_text: 'Looking at the chart shown — a candle near the right with a small body near the top and a long lower wick — what does this candle signal?',
          options: [
            'Bearish momentum — sellers are in control',
            'Bullish rejection — buyers aggressively rejected lower prices',
            'Consolidation — neither buyers nor sellers are active',
            'A guaranteed reversal regardless of context',
          ],
          correct_answer: 'Bullish rejection — buyers aggressively rejected lower prices',
          explanation: 'The long lower wick shows price pushed down but was forcefully bought back up, leaving the body near the top — a bullish pin bar.',
          visual_config: {
            type: 'candlestick',
            data: DATASET_PIN_BAR,
          },
          order_num: 5,
        },
      ],
    },
    {
      order_num: 7,
      title: 'Engulfing Candle Patterns',
      content: `An engulfing pattern is a two-candle signal. A bullish engulfing occurs when a bearish candle is followed by a larger bullish candle whose body fully covers (engulfs) the prior candle's body — a visible shift from sellers to buyers. A bearish engulfing is the mirror: a bearish candle whose body fully engulfs the prior bullish body. The second candle's body must be larger than the first. Strength factors: the bigger the second candle relative to the first, the stronger the signal; the pattern forms at a significant level; and the signal aligns with broader context. Engulfing patterns in isolation — no key level, no trend context — are unreliable.`,
      visual_type: null,
      visual_config: null,
      common_mistakes: [
        'Accepting engulfing patterns where the second candle barely overlaps',
        'Taking signals with no key level or trend context',
        'Treating engulfing patterns as a standalone trading system',
        'Ignoring trend direction when interpreting the signal',
        'Confusing an engulfing candle with an inside bar',
      ],
      key_takeaways: [
        'Bullish engulfing: smaller bearish body then larger bullish body engulfs it',
        'Bearish engulfing: smaller bullish body then larger bearish body engulfs it',
        'Second candle body must completely engulf the first body',
        'Strongest at significant S/R levels aligned with HTF trend',
        'Use as confirmation — not as the sole reason to trade',
      ],
      estimated_minutes: 4,
      questions: [
        {
          type: 'multiple_choice',
          question_text: 'In a bullish engulfing pattern, the second candle must:',
          options: [
            'Have a long upper wick',
            'Fully engulf the body of the previous bearish candle with its own bullish body',
            'Form at the open of the trading session',
            'Be smaller than the first candle',
          ],
          correct_answer: 'Fully engulf the body of the previous bearish candle with its own bullish body',
          explanation: 'The defining feature is the second (bullish) candle\'s body being larger than and covering the first (bearish) candle\'s body.',
          visual_config: null,
          order_num: 1,
        },
        {
          type: 'true_false',
          question_text: 'A bearish engulfing pattern at a strong resistance level in a downtrend is a high-quality signal.',
          options: null,
          correct_answer: 'true',
          explanation: 'Three factors align: bearish reversal pattern + resistance + downtrend bias. Multiple confluences increase probability.',
          visual_config: null,
          order_num: 2,
        },
        {
          type: 'multiple_choice',
          question_text: 'An engulfing pattern\'s reliability increases most when:',
          options: [
            'It forms in random price space between key levels',
            'It forms at a significant key level with higher-timeframe trend alignment',
            'It forms on a 1-minute chart with high frequency',
            'Both candles in the pattern are the same size',
          ],
          correct_answer: 'It forms at a significant key level with higher-timeframe trend alignment',
          explanation: 'Confluence — level + pattern + trend alignment — is what separates reliable signals from random noise.',
          visual_config: null,
          order_num: 3,
        },
        {
          type: 'true_false',
          question_text: 'The wicks of the two candles are what determine whether a pattern qualifies as an engulfing.',
          options: null,
          correct_answer: 'false',
          explanation: 'Only the bodies matter for engulfing classification. The second candle\'s body must engulf the first candle\'s body.',
          visual_config: null,
          order_num: 4,
        },
        {
          type: 'multiple_choice',
          question_text: 'What distinguishes a bullish engulfing from a bullish pin bar?',
          options: [
            'A bullish engulfing uses only one candle',
            'A bullish engulfing is a two-candle pattern where the second body engulfs the first',
            'A pin bar always forms at resistance levels',
            'They are identical patterns with different names',
          ],
          correct_answer: 'A bullish engulfing is a two-candle pattern where the second body engulfs the first',
          explanation: 'A pin bar is a single candle with a long wick. An engulfing requires two candles where the second body covers the first.',
          visual_config: null,
          order_num: 5,
        },
      ],
    },
    {
      order_num: 8,
      title: 'Inside Bar Setups',
      content: `An inside bar is a two-candle pattern where the second candle's high and low are completely contained within the range of the first candle (the "mother bar"). The inside bar represents a pause or consolidation — neither buyers nor sellers have committed. This pause often resolves with a breakout in the direction of the prevailing trend. Entry: place a buy stop above the mother bar's high for a bullish break, or a sell stop below the mother bar's low for a bearish break. Stop goes on the opposite side of the mother bar. Inside bars work best when the mother bar is a strong directional candle and the pattern forms in a trending environment after a pullback, not during random chop.`,
      visual_type: null,
      visual_config: null,
      common_mistakes: [
        'Taking inside bars during choppy, directionless ranging markets',
        'Using large sizes because the stop appears visually tight',
        'Ignoring whether the mother bar has directional conviction',
        'Entering before the breakout occurs',
        'Treating every small consolidation candle as a valid inside bar',
      ],
      key_takeaways: [
        'Inside bar = second candle\'s range completely within the first (mother bar)',
        'Represents a pause before potential continuation',
        'Enter on breakout of mother bar high (bullish) or low (bearish)',
        'Stop placed on opposite side of the mother bar',
        'Best in clear trending markets after a directional impulse',
      ],
      estimated_minutes: 4,
      questions: [
        {
          type: 'multiple_choice',
          question_text: 'An inside bar is defined as:',
          options: [
            'Two candles with equal closing prices',
            'A candle whose full range (high and low) is entirely within the previous candle\'s range',
            'A candle with no wicks at all',
            'Two consecutive green candles of increasing size',
          ],
          correct_answer: 'A candle whose full range (high and low) is entirely within the previous candle\'s range',
          explanation: 'The inside bar\'s high must be lower than the mother bar\'s high AND its low must be higher than the mother bar\'s low.',
          visual_config: null,
          order_num: 1,
        },
        {
          type: 'true_false',
          question_text: 'Inside bars work best as trading setups in choppy, directionless ranging markets.',
          options: null,
          correct_answer: 'false',
          explanation: 'Inside bars need a directional bias to break convincingly. In choppy ranges they fakeout frequently in both directions.',
          visual_config: null,
          order_num: 2,
        },
        {
          type: 'multiple_choice',
          question_text: 'When trading a bullish inside bar breakout, where is the entry typically placed?',
          options: [
            'Below the inside bar\'s low',
            'Above the mother bar\'s high',
            'At the midpoint of the mother bar',
            'At the open of the candle following the inside bar',
          ],
          correct_answer: 'Above the mother bar\'s high',
          explanation: 'The breakout entry is placed just above the mother bar\'s high. A close above this level confirms bullish conviction.',
          visual_config: null,
          order_num: 3,
        },
        {
          type: 'true_false',
          question_text: 'The stop loss on an inside bar trade is typically placed on the opposite side of the mother bar.',
          options: null,
          correct_answer: 'true',
          explanation: 'If bullish (entry above mother bar high), the stop goes below the mother bar\'s low — the point where the bullish structure is invalidated.',
          visual_config: null,
          order_num: 4,
        },
        {
          type: 'multiple_choice',
          question_text: 'What does the inside bar pattern fundamentally represent?',
          options: [
            'A guaranteed continuation of the previous trend',
            'A period of indecision and consolidation before a potential breakout',
            'A confirmed reversal of the prior directional move',
            'A candle that always leads to a range-bound market',
          ],
          correct_answer: 'A period of indecision and consolidation before a potential breakout',
          explanation: 'The inside bar shows neither side has taken over. The tension resolves when one side breaks the mother bar boundary.',
          visual_config: null,
          order_num: 5,
        },
      ],
    },
    {
      order_num: 9,
      title: 'Consolidation and Range Markets',
      content: `A range forms when price oscillates between a defined support floor and resistance ceiling without making consistent new highs or lows. Markets spend more time ranging than trending. In a range, the core strategy is: buy near support (when candle signals appear there), sell near resistance, and avoid entries in the middle of the range where risk/reward is poor. The boundaries are the highest-probability entry zones. Ranges eventually break. A genuine breakout from a range often leads to a significant move roughly equal to the range height projected from the breakout point. Wait for a retest of the broken boundary before entering the breakout move, as fakeouts are very common in ranges.`,
      visual_type: null,
      visual_config: null,
      common_mistakes: [
        'Entering range trades in the middle of the range where R:R is poor',
        'Not recognizing that range boundaries are zones, not exact lines',
        'Taking range bounces against a strong higher-timeframe trend',
        'Chasing the initial range breakout without waiting for retest',
        'Forcing trend-following strategies into a ranging environment',
      ],
      key_takeaways: [
        'Range: price oscillates between support floor and resistance ceiling',
        'Markets range more than they trend',
        'Trade from range boundaries — not the middle',
        'Range breakout target ≈ range height projected from the breakout',
        'Adjust strategy to market conditions: trend vs. range',
      ],
      estimated_minutes: 5,
      questions: [
        {
          type: 'multiple_choice',
          question_text: 'The highest-probability entry zone in a ranging market is:',
          options: [
            'The exact midpoint of the range',
            'Near the range boundaries (support or resistance)',
            'Anywhere inside the range at any time',
            'Just outside the range before a potential breakout',
          ],
          correct_answer: 'Near the range boundaries (support or resistance)',
          explanation: 'At boundaries, risk is clearly defined (stop just beyond the boundary) and reward is the full range width — optimal R:R.',
          visual_config: null,
          order_num: 1,
        },
        {
          type: 'true_false',
          question_text: 'Financial markets spend more time trending than they do ranging/consolidating.',
          options: null,
          correct_answer: 'false',
          explanation: 'Studies of market data consistently show markets range/consolidate the majority of the time, with trending phases being the minority.',
          visual_config: null,
          order_num: 2,
        },
        {
          type: 'multiple_choice',
          question_text: 'A range breakout target is commonly estimated as:',
          options: [
            '50% of the range height',
            'Double the range height',
            'Equal to the range height projected from the breakout point',
            'Always a fixed 50-pip target',
          ],
          correct_answer: 'Equal to the range height projected from the breakout point',
          explanation: 'The "measured move" technique projects the range height beyond the breakout, giving a logical profit target.',
          visual_config: null,
          order_num: 3,
        },
        {
          type: 'true_false',
          question_text: 'Buying at the midpoint of a range is an optimal entry strategy.',
          options: null,
          correct_answer: 'false',
          explanation: 'Mid-range entries have poor R:R — your stop is far from a structural level and your target (the boundary) is equally far.',
          visual_config: null,
          order_num: 4,
        },
        {
          type: 'multiple_choice',
          question_text: 'To distinguish a genuine range breakout from a fakeout, traders typically:',
          options: [
            'Enter immediately on the close of the breakout candle',
            'Wait for a retest of the broken boundary before entering',
            'Use a single candle signal inside the range as confirmation',
            'Simply ignore breakouts and only trade range bounces',
          ],
          correct_answer: 'Wait for a retest of the broken boundary before entering',
          explanation: 'A retest confirms the level has changed role (resistance became support or vice versa) — reducing the risk of being caught in a fakeout.',
          visual_config: null,
          order_num: 5,
        },
      ],
    },
    {
      order_num: 10,
      title: 'Price Action Entry Techniques',
      content: `Once you have identified the trend, found a key level, and spotted a candle signal, you need a precise entry method. Three common approaches: (1) Close of signal candle — enter at candle close; simple, no second-guessing. (2) Retest entry — wait for price to return to the signal area for a better price and tighter stop. (3) Limit order — set in advance at the key level; good for busy traders. Exit techniques: set profit target at the next significant S/R level in the direction of the trade; trail stop behind new structural swings as the trade develops. Always calculate R:R before entering — minimum 1.5:1, preferably 2:1+. No valid R:R = no trade.`,
      visual_type: null,
      visual_config: null,
      common_mistakes: [
        'Entering without calculating risk-to-reward ratio first',
        'Chasing price away from the entry zone',
        'Moving profit targets higher mid-trade out of greed',
        'Using arbitrary fixed pip stops instead of structure-based stops',
        'Exiting early due to emotional pressure rather than structural reason',
      ],
      key_takeaways: [
        'Three entry methods: candle close, retest, or limit order',
        'Always calculate R:R before entering — aim for 2:1 or better',
        'Structure-based stops (behind swings/levels) beat arbitrary pips',
        'Set profit targets at the next meaningful S/R level',
        'No valid R:R = skip the trade; patience is a skill',
      ],
      estimated_minutes: 5,
      questions: [
        {
          type: 'multiple_choice',
          question_text: 'The minimum risk-to-reward ratio typically recommended before taking a trade is:',
          options: ['0.5:1', '1:1', '1.5:1', '5:1 minimum only'],
          correct_answer: '1.5:1',
          explanation: 'A minimum of 1.5:1 R:R means your potential reward is 1.5× your risk. Most professional traders prefer 2:1 or better.',
          visual_config: null,
          order_num: 1,
        },
        {
          type: 'true_false',
          question_text: 'It is acceptable to enter a trade without first calculating the risk-to-reward ratio.',
          options: null,
          correct_answer: 'false',
          explanation: 'Without calculating R:R you have no idea if the trade makes mathematical sense. Skipping this step leads to poor long-term results.',
          visual_config: null,
          order_num: 2,
        },
        {
          type: 'multiple_choice',
          question_text: 'A "retest entry" technique means:',
          options: [
            'Entering before the signal candle closes',
            'Waiting for price to return to the signal area for a better price and tighter stop',
            'Entering the same trade direction twice in quick succession',
            'Entering immediately at the current market price',
          ],
          correct_answer: 'Waiting for price to return to the signal area for a better price and tighter stop',
          explanation: 'A retest entry gives a better fill, a smaller stop loss (structure is nearby), and confirms the level held — improving R:R.',
          visual_config: null,
          order_num: 3,
        },
        {
          type: 'multiple_choice',
          question_text: 'Where should profit targets ideally be placed?',
          options: [
            'At a fixed pip target regardless of market conditions',
            'At the next significant support/resistance level in the trade direction',
            'Wherever an ATR indicator suggests',
            'At breakeven immediately after entry',
          ],
          correct_answer: 'At the next significant support/resistance level in the trade direction',
          explanation: 'S/R levels are where opposing pressure is most likely to appear. Setting targets there maximizes the probability of hitting your goal.',
          visual_config: null,
          order_num: 4,
        },
        {
          type: 'true_false',
          question_text: 'Structure-based stop losses (behind swing points or levels) are preferable to arbitrary fixed-pip stops.',
          options: null,
          correct_answer: 'true',
          explanation: 'Structure-based stops are placed where the trade idea is invalidated. Fixed-pip stops may be too tight (volatility stops you out) or too wide (poor R:R).',
          visual_config: null,
          order_num: 5,
        },
      ],
    },
  ];

  for (const lesson of lessons) {
    const { questions, ...lessonData } = lesson;
    const lessonResult = await client.query(
      `INSERT INTO lessons (level_id, order_num, title, content, visual_type, visual_config, common_mistakes, key_takeaways, estimated_minutes)
       VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9) RETURNING id`,
      [
        levelId,
        lessonData.order_num,
        lessonData.title,
        lessonData.content,
        lessonData.visual_type,
        lessonData.visual_config ? JSON.stringify(lessonData.visual_config) : null,
        JSON.stringify(lessonData.common_mistakes),
        JSON.stringify(lessonData.key_takeaways),
        lessonData.estimated_minutes,
      ]
    );
    const lessonId: number = lessonResult.rows[0].id;

    for (const q of questions) {
      await client.query(
        `INSERT INTO questions (lesson_id, type, question_text, options, correct_answer, explanation, visual_config, order_num)
         VALUES ($1,$2,$3,$4,$5,$6,$7,$8)`,
        [
          lessonId,
          q.type,
          q.question_text,
          q.options ? JSON.stringify(q.options) : null,
          q.correct_answer,
          q.explanation,
          q.visual_config ? JSON.stringify(q.visual_config) : null,
          q.order_num,
        ]
      );
    }
  }

  console.log(`  ✓ Level 1: ${lessons.length} lessons inserted`);
}
